# Template file for 'bitcoin'
pkgname=bitcoin
version=29.3.knots20260210
revision=1
build_style=cmake
configure_args="-DBUILD_TESTS=ON -DBUILD_TX=ON -DBUILD_GUI=ON -DBUILD_CLI=ON -DBUILD_DAEMON=ON -WITH_CCACHE=OFF"
hostmakedepends="automake libtool pkg-config yasm librsvg-utils ImageMagick"
makedepends="db-devel boost-devel-minimal miniupnpc-devel qt5-tools-devel
 libevent-devel qrencode-devel sqlite-devel capnproto-devel librsvg-devel"
short_desc="Bitcoin is a peer-to-peer network based digital currency"
maintainer="Jason Elswick <jason@jasondavid.us>"
license="MIT"
homepage="https://bitcoinknots.org/"
distfiles="https://github.com/bitcoinknots/bitcoin/archive/refs/tags/v${version}.tar.gz"
checksum=6f61fa3a33e9f519c6234f87288a8408e97667e45eea27c2cf21041e46e3a84b
skip_extraction="bitcoin-qt.desktop bitcoin128.png"
CFLAGS="-UNDEBUG"
CXXFLAGS="-UNDEBUG"

system_accounts="_bitcoin"
_bitcoin_homedir="/var/lib/bitcoin"
make_dirs="/var/lib/bitcoin 0755 _bitcoin _bitcoin"

if [ "$CROSS_BUILD" ]; then
	hostmakedepends+=" qt5-host-tools"
fi

pre_configure() {
	case "$XBPS_TARGET_MACHINE" in
	aarch64*)
		CFLAGS=${CFLAGS/armv8-a/armv8-a+crc+crypto}
		CXXFLAGS=${CXXFLAGS/armv8-a/armv8-a+crc+crypto}
		;;
	esac
}

pre_build() {
	export BITCOIN_GENBUILD_NO_GIT=1
}

post_install() {
	vlicense COPYING
	vsv bitcoind
}

bitcoin-qt_package() {
	depends="desktop-file-utils"
	short_desc+=" - QT GUI"
	pkg_install() {
		vmove usr/bin/bitcoin-qt
		vmove usr/share/man/man1/bitcoin-qt.1
		#vinstall ${XBPS_SRCDISTDIR}/${sourcepkg}-${version}/bitcoin-qt.desktop 644 usr/share/applications
		#vinstall ${XBPS_SRCDISTDIR}/${sourcepkg}-${version}/bitcoin128.png 644 usr/share/pixmaps
		vlicense COPYING
		rm "${DESTDIR}"/usr/bin/test_bitcoin-qt
	}
}
